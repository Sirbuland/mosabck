machine:
  ruby:
    version: 2.4.3
  node:
    version: 8.2.1
  environment:
    CIRCLE_ENV: test
    DATABASE_URL: postgis://ubuntu:@127.0.0.1:5432/circle_test
    TEST_CLUSTER_COMMAND: /home/ubuntu/lancher_es/elasticsearch-2.3.4/bin/elasticsearch
dependencies:
  cache_directories:
    - elasticsearch-2.4.3 # relative to the build directory
  post:
    - if [[ ! -e elasticsearch-2.4.3 ]]; then wget https://download.elastic.co/elasticsearch/release/org/elasticsearch/distribution/tar/elasticsearch/2.4.3/elasticsearch-2.4.3.tar.gz && tar -xvf elasticsearch-2.4.3.tar.gz; fi
    - elasticsearch-2.4.3/bin/elasticsearch: {background: true}
    - sleep 10 && wget --waitretry=5 --retry-connrefused -v http://127.0.0.1:9200/
database:
  override:
    - cp config/database.yml.ci config/database.yml
    - bundle exec rake db:drop RAILS_ENV=test
    - bundle exec rake db:create RAILS_ENV=test
    - bundle exec rake db:migrate RAILS_ENV=test
test:
    post:
      - bundle exec rake code_analysis
